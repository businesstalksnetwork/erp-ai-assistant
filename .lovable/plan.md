

## Upgrade AI: Role-Based Intelligence Hub + Enhanced Analytics

### Problem

The current AI has solid foundations -- streaming chat with SQL tool-calling, rule-based insights with AI enrichment, and per-module narrative analysis. But it's limited:

1. **No role awareness** -- Owner/CEO and a store clerk get the same insights
2. **AI Copilot sidebar is narrow** (280px) and only shows on desktop -- no dedicated AI page
3. **No "Executive Summary"** for owners/CEOs who want one-click company overview
4. **Analytics narrative only covers 15 context types** -- missing production, CRM pipeline, HR headcount, POS performance
5. **AI chat has only 3 tools** (SQL, trends, reminders) -- missing comparison, forecasting, what-if tools
6. **Insights widget on dashboard shows raw alerts** but no strategic synthesis or KPI scorecard
7. **No personalized daily briefing** -- users have to manually click around

---

### What We'll Build

#### 1. AI Executive Briefing Page (`/ai/briefing`)

A dedicated full-page AI dashboard that generates a comprehensive company briefing tailored to the user's role:

- **Owner/CEO/Admin**: Full company overview -- revenue, expenses, profit trend, cash position, AR/AP aging summary, top risks, HR headcount, production status, CRM pipeline value
- **Manager**: Department-specific KPIs, team performance, pending approvals, inventory alerts
- **Accountant**: GL health, unposted journals, bank reconciliation status, tax deadlines, open items aging
- **Sales**: Pipeline value, close rates, overdue quotes, top opportunities, commission tracking
- **HR**: Headcount changes, payroll cost trend, leave utilization, contract expirations
- **Store/POS**: Daily sales vs target, top products, stock alerts, session summary

The briefing will be generated by a new `ai-executive-briefing` edge function that:
- Detects user role from `tenant_members`
- Runs role-specific SQL queries to gather KPI data
- Sends structured data to Gemini with role-specific system prompt
- Returns structured sections (scorecard, risks, actions, trends)
- Caches for 30 minutes per user

#### 2. Enhanced AI Assistant Tools

Add 4 new tools to the `ai-assistant` edge function:

- **`compare_periods`**: Compare any metric between two time periods (e.g., "Compare Q1 vs Q2 revenue")
- **`what_if_scenario`**: Simple scenario projection (e.g., "What if we increase prices by 10%?")
- **`get_kpi_scorecard`**: Returns a pre-built KPI dashboard in one call (revenue, expenses, profit margin, DSO, current ratio, employee count, inventory value)
- **`explain_account`**: Deep dive into a specific GL account -- balance, recent transactions, monthly trend

#### 3. Expanded Analytics Narratives

Add 5 new context types to `ai-analytics-narrative`:

- `production` -- Production order completion rate, bottleneck analysis, capacity utilization
- `crm_pipeline` -- Pipeline value by stage, conversion rates, average deal size
- `hr_overview` -- Headcount, payroll as % of revenue, turnover indicators
- `pos_performance` -- Daily average, top products, peak hours analysis
- `purchasing` -- Supplier concentration, PO fulfillment rate, price variance

#### 4. Smart Dashboard Widget Upgrade

Replace the flat insight list on the Dashboard with a structured AI scorecard:
- Traffic-light KPI indicators (green/amber/red)
- 1-sentence executive summary at the top
- Grouped insights by category (Financial, Operations, People, Sales)
- "Deep dive" button per category that opens the AI chat pre-filled with the right question

---

### Technical Plan

#### New Files

| File | Purpose |
|------|---------|
| `supabase/functions/ai-executive-briefing/index.ts` | Role-based briefing generator with structured output |
| `src/pages/tenant/AiBriefing.tsx` | Full-page AI briefing dashboard |

#### Modified Files

| File | Change |
|------|--------|
| `supabase/functions/ai-assistant/index.ts` | Add 4 new tools: `compare_periods`, `what_if_scenario`, `get_kpi_scorecard`, `explain_account` |
| `supabase/functions/ai-analytics-narrative/index.ts` | Add 5 new context types with system prompts |
| `src/components/ai/AiInsightsWidget.tsx` | Upgrade to show grouped scorecard with executive summary and deep-dive buttons |
| `src/components/ai/AiAnalyticsNarrative.tsx` | Add the 5 new context types to the Props interface |
| `src/App.tsx` | Add route for `/ai/briefing` |
| `src/layouts/TenantLayout.tsx` | Add "AI Briefing" nav item |

#### Edge Function: `ai-executive-briefing`

```
Flow:
1. Auth check + get user role from tenant_members
2. Based on role, run parallel SQL queries:
   - Financial: revenue, expenses, profit, cash, AR/AP
   - Operations: inventory value, low stock, production orders
   - People: headcount, payroll cost, leave utilization
   - Sales: pipeline, leads, conversion
3. Send all data to Gemini with role-specific prompt
4. Use tool_choice to get structured output:
   {
     summary: string,           // 2-3 sentence executive overview
     scorecard: KPI[],          // {label, value, trend, status}
     risks: Risk[],             // {title, severity, action}
     actions: string[],         // Top 5 recommended actions
     sections: Section[]        // {title, narrative, metrics}
   }
5. Cache result per user+tenant for 30 min
6. Return structured JSON
```

#### New AI Assistant Tools

**compare_periods**: Takes metric + two date ranges, runs aggregation queries for both, returns comparison with delta and percentage change.

**what_if_scenario**: Takes a scenario description (price change, headcount change, etc.), fetches current actuals, projects impact using simple linear models, returns projected outcomes.

**get_kpi_scorecard**: Single call that returns all major KPIs -- no SQL needed, pre-built queries for revenue, expenses, margin, DSO, current ratio, employee count, inventory value, pipeline value.

**explain_account**: Takes an account code or name, returns the account's current balance, last 10 transactions, and monthly trend for the past 6 months.

#### Dashboard Widget Upgrade

The `AiInsightsWidget` will be enhanced to:
1. Show the `ai_summary` from the insights response (currently returned but not displayed)
2. Group insights by category (Financial, Operations, People, Sales)
3. Add a KPI scorecard row at the top with traffic-light indicators
4. Add "Ask AI" buttons that open the copilot with pre-filled questions

#### Navigation

Add "AI Briefing" as a top-level nav item with a Sparkles icon, visible to all roles. The briefing content automatically adapts based on the user's role.

### What This Enables

After implementation, every person in the company gets role-appropriate answers:

- **Owner/CEO**: "Show me everything" -- full company health in one page
- **CFO/Accountant**: "What needs posting? What's our cash position? Any tax risks?"
- **Sales Manager**: "How's the pipeline? Which deals are at risk? Who's our top performer?"
- **HR Manager**: "What's our payroll trend? Any contracts expiring? Leave utilization?"
- **Store Manager**: "How did we do today? What's selling? What's out of stock?"
- **Any user via chat**: "Compare this quarter vs last quarter", "What if we hire 3 more people?", "Explain account 5000"
